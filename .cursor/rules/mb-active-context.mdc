---
description: SOURCE OF TRUTH for the current project state. Contains session focus, active tasks, and recent decisions. MUST READ at the start of tasks. MUST UPDATE upon completion.
globs: **/*
---

# Active Context & Session State

## 1. Current Context
- **Project Type**: Monorepo - "Distributed Systems Lab"
- **Main Focus**: Three interconnected production-grade systems demonstrating enterprise patterns
- **Status**: **Phase 0 COMPLETE.** Foundation infrastructure ready. Starting Phase 1 (Ingestion API).

## 2. Monorepo Structure

### Project Architecture
```
distributed-systems-lab/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ ingestion-api/     (NestJS + Fastify + BullMQ) - NOT STARTED
â”‚   â”œâ”€â”€ live-dashboard/    (Next.js 14 + Zustand + Socket.io) - NOT STARTED
â”‚   â””â”€â”€ stream-engine/     (Node.js Streams + Fastify) - NOT STARTED
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ dto/               âœ… @distributed-systems-lab/dto
â”‚   â”œâ”€â”€ database/          âœ… @distributed-systems-lab/database
â”‚   â”œâ”€â”€ eslint-config/     âœ… @distributed-systems-lab/eslint-config
â”‚   â””â”€â”€ logger/            âœ… @distributed-systems-lab/logger
â”œâ”€â”€ specs/
â”‚   â”œâ”€â”€ SPEC-INGESTION-API.md  (Source of Truth for Project 1)
â”‚   â”œâ”€â”€ SPEC-DASHBOARD.md      (Source of Truth for Project 2)
â”‚   â””â”€â”€ SPEC-STREAMS.MD        (Source of Truth for Project 3)
â”œâ”€â”€ .cursor/rules/
â”‚   â”œâ”€â”€ mb-active-context.mdc
â”‚   â”œâ”€â”€ mb-commands.mdc
â”‚   â”œâ”€â”€ mb-product-context.mdc
â”‚   â”œâ”€â”€ mb-system-patterns.mdc
â”‚   â””â”€â”€ mb-tech-stack.mdc
â”œâ”€â”€ docker-compose.yaml    âœ… PostgreSQL 16 + Redis 7
â”œâ”€â”€ package.json           âœ… pnpm workspaces monorepo
â”œâ”€â”€ pnpm-workspace.yaml    âœ… Workspace config
â”œâ”€â”€ tsconfig.json          âœ… Base TypeScript config (strict)
â”œâ”€â”€ .prettierrc            âœ… Code formatting
â””â”€â”€ TODO.md                ðŸ“‹ Implementation roadmap
```

### Source of Truth Hierarchy
1. **Specifications** (`specs/SPEC-*.md`) - Business requirements and acceptance criteria
2. **Memory Bank** (`.cursor/rules/mb-*.mdc`) - Technical patterns and current state
3. **TODO.md** - Detailed implementation roadmap with checklists
4. **Code Implementation** - Must align with specs, Memory Bank, and TODO

## 3. Recent Changes
| Date | Type | Description |
| :--- | :--- | :--- |
| 2026-01-07 | Package | Created `@distributed-systems-lab/logger` - Pino logger factory with dev/prod configs |
| 2026-01-07 | Package | Created `@distributed-systems-lab/eslint-config` - ESLint 9 flat configs for NestJS, Next.js, Node.js |
| 2026-01-07 | Package | Created `@distributed-systems-lab/database` - Drizzle ORM with webhook_events schema and migrations |
| 2026-01-07 | Package | Created `@distributed-systems-lab/dto` - Shared types (WebhookJobData, WebhookEvent, SocketEvents) |
| 2026-01-07 | Infra | Configured Docker Compose with PostgreSQL 16 + Redis 7 (health checks, volumes, network) |
| 2026-01-07 | Infra | Initialized pnpm workspaces monorepo with root tsconfig.json and Prettier |
| 2026-01-07 | Infra | Updated Memory Bank files to reflect monorepo architecture with 3 projects |
| 2026-01-06 | Infra | Created `mb-commands.mdc` with standardized AI commands for self-directed development |

## 4. Project Status

### Phase 0: Foundation âœ… COMPLETE
- [x] Monorepo initialized (pnpm workspaces)
- [x] Docker Compose (PostgreSQL 16 + Redis 7)
- [x] Root TypeScript config (strict mode)
- [x] Prettier configuration
- [x] `@distributed-systems-lab/dto` package
- [x] `@distributed-systems-lab/database` package (with migrations applied)
- [x] `@distributed-systems-lab/eslint-config` package
- [x] `@distributed-systems-lab/logger` package

### Project 1: Ingestion API (`apps/ingestion-api`)
- **Status**: **STARTING** - Phase 1.1 Initialize NestJS
- **Tech Stack**: NestJS 10+ + FastifyAdapter + BullMQ + PostgreSQL + Drizzle ORM
- **Key Features**: Webhook ingestion, async processing, idempotency checks, health monitoring
- **Target KPIs**: 500 VUs, < 100ms P95, < 1% error rate
- **Current Phase**: Phase 1.1 - Initialize NestJS with Fastify

### Project 2: Live Dashboard (`apps/live-dashboard`)
- **Status**: Not started
- **Tech Stack**: Next.js 14 (App Router) + Zustand + Socket.io + Recharts + TailwindCSS
- **Key Features**: Real-time RPS chart, live event stream, socket reconnection
- **Target KPIs**: 60 FPS with 100+ events/sec, < 200ms latency, < 70% CPU
- **Dependencies**: Requires Project 1 WebSocket gateway

### Project 3: Stream Engine (`apps/stream-engine`)
- **Status**: Not started
- **Tech Stack**: Node.js 20 Streams + Fastify + pg-copy-streams
- **Key Features**: Memory-efficient CSV processing, backpressure handling, bulk inserts
- **Target KPIs**: Process 2GB+ files in 512MB RAM, > 10k rows/sec
- **Dependencies**: Requires shared database module

### Shared Packages
| Package | Status | Description |
|---------|--------|-------------|
| `@distributed-systems-lab/dto` | âœ… | WebhookJobData<T>, WebhookEvent<T>, SocketEvents, IngestResponseDto |
| `@distributed-systems-lab/database` | âœ… | Drizzle ORM, webhookEvents schema, connection pool, migrations |
| `@distributed-systems-lab/eslint-config` | âœ… | ESLint 9 flat configs: base, nestjs, nextjs, node |
| `@distributed-systems-lab/logger` | âœ… | Shared pino logger with service context, dev/prod modes |

## 5. Next Steps (Checklist)

### Phase 1: Ingestion API (Current Focus)
- [ ] Phase 1.1: Initialize NestJS with FastifyAdapter + nestjs-pino
- [ ] Phase 1.2: Configure DatabaseModule with Drizzle ORM
- [ ] Phase 1.3: Setup BullMQ queue configuration
- [ ] Phase 1.4: Implement WebhookController + DTO validation
- [ ] Phase 1.5: Implement WebhookProcessor with idempotency
- [ ] Phase 1.6: Add HealthModule with Terminus
- [ ] Phase 1.7: Add WebSocket Gateway for dashboard
- [ ] Phase 1.8: Security & Rate Limiting
- [ ] Phase 1.9: K6 load testing (500 VUs acceptance test)

### Phase 2: Live Dashboard (After Ingestion API)
- [ ] Initialize Next.js 14 with App Router
- [ ] Setup Zustand store for metrics
- [ ] Implement Socket.io client with reconnection
- [ ] Create ThroughputChart with throttled updates
- [ ] Implement LiveLogStream with TanStack Virtual
- [ ] Performance testing (Freeze Test)

### Phase 3: Stream Engine (After Dashboard)
- [ ] Setup Fastify with multipart support
- [ ] Implement streaming CSV parser
- [ ] Create validation Transform stream
- [ ] Implement Postgres COPY stream destination
- [ ] Add memory monitoring
- [ ] OOM testing (5M rows in 512MB)

## 6. Active Architecture Decisions

### Monorepo Strategy (Decided)
- **Package Manager**: pnpm (v10.23.0) with workspaces
- **Structure**: `apps/*` for applications, `packages/*` for shared code
- **Shared Code**: Types (dto), database (Drizzle), linting (ESLint configs)

### Development Workflow
- **Memory Bank**: Native `.cursor/rules` system with `.mdc` files
- **Command-Based**: Use `/guide`, `/summarize`, `/commit`, etc. for structured AI interactions
- **AI Role**: Assistant/guide - user writes code, AI provides guidance
- **Git Hygiene**: Conventional Commits via `/commit` command
- **Roadmap**: `TODO.md` contains detailed implementation checklist

### Project Interconnections
- **Ingestion API â†’ Dashboard**: WebSocket events for real-time metrics (job-completed)
- **Ingestion API â†” Stream Engine**: Shared PostgreSQL database via `@distributed-systems-lab/database`
- **All Projects**: Import shared types from `@distributed-systems-lab/dto`

### Infrastructure (Configured)
- **Database**: PostgreSQL 16 Alpine at `localhost:5432` (Docker)
- **Queue**: Redis 7 Alpine at `localhost:6379` (Docker)
- **Network**: `distributed-lab-network` (Docker bridge)
- **Data Persistence**: `.docker/postgres-data`, `.docker/redis-data`

### Port Assignments
| Service | Port |
|---------|------|
| Live Dashboard | 3000 |
| Ingestion API | 3001 |
| Stream Engine | 3002 |
| PostgreSQL | 5432 |
| Redis | 6379 |

### Testing Strategy
- **Ingestion API**: K6 load testing (500 VUs, P95 < 100ms)
- **Dashboard**: Browser performance monitoring (CPU < 70%, 60 FPS)
- **Stream Engine**: OOM testing (2GB file in 512MB container)

## 7. Critical Constraints

### Performance Requirements
- **Ingestion API**: Must use FastifyAdapter (NOT ExpressAdapter)
- **Dashboard**: Must throttle UI updates to avoid re-render storms
- **Stream Engine**: Must use `stream.pipeline()` (FORBID `fs.readFileSync`)

### Code Quality Standards
- **TypeScript**: Strict mode enabled, zero `any` types
- **SOLID Principles**: Mandatory across all projects
- **Error Handling**: Result Pattern for business logic, try/catch at boundaries
- **Documentation**: JSDoc on all public functions/classes
- **Logging**: Structured JSON logs (pino for backend)
- **Linting**: Use `@distributed-systems-lab/eslint-config/*` presets

## 8. Environment Configuration

### Local Development (.env)
```env
# Database (use localhost for local dev, postgres for Docker-to-Docker)
DB_HOST=localhost
DB_PORT=5432
DB_USER=dev_user
DB_PASSWORD=dev_password
DB_NAME=distributed_lab

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# App Ports
API_PORT=3001
DASHBOARD_PORT=3000
STREAM_ENGINE_PORT=3002
```

### Docker Scripts (package.json)
- `pnpm docker:up` - Start PostgreSQL + Redis
- `pnpm docker:down` - Stop containers
- `pnpm docker:logs` - View logs
- `pnpm docker:db` - PostgreSQL CLI
- `pnpm docker:redis` - Redis CLI
- `pnpm docker:clean` - Remove volumes + orphans

## 9. Open Questions / Blockers
- None. Ready to begin Phase 1 (Ingestion API).
