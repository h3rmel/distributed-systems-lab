---
description: SOURCE OF TRUTH for the current project state. Contains session focus, active tasks, and recent decisions. MUST READ at the start of tasks. MUST UPDATE upon completion.
globs: **/*
---

# Active Context & Session State

## 1. Current Context
- **Project Type**: Monorepo - "Distributed Systems Lab"
- **Main Focus**: Three interconnected production-grade systems demonstrating enterprise patterns
- **Status**: **Phase 1 COMPLETE** - Ingestion API fully implemented with comprehensive test coverage. Current: Phase 3 (Stream API) - switched order with Phase 2.

## 2. Monorepo Structure

### Project Architecture
```
distributed-systems-lab/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ ingestion-api/     (NestJS + Fastify + BullMQ) - âœ… COMPLETE (with 97%+ test coverage)
â”‚   â”œâ”€â”€ live-dashboard/    (Next.js 14 + Zustand + Socket.io) - NOT STARTED
â”‚   â””â”€â”€ stream-api/        (Node.js Streams + Fastify) - ðŸš§ IN PROGRESS (Phase 3.11 complete)
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ dto/               âœ… @distributed-systems-lab/dto
â”‚   â”œâ”€â”€ database/          âœ… @distributed-systems-lab/database
â”‚   â””â”€â”€ eslint-config/     âœ… @distributed-systems-lab/eslint-config
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ SPEC-INGESTION-API.md  (Source of Truth for Project 1)
â”‚   â”œâ”€â”€ SPEC-DASHBOARD.md      (Source of Truth for Project 2)
â”‚   â”œâ”€â”€ SPEC-STREAM-API.md     (Source of Truth for Project 3)
â”‚   â””â”€â”€ adr/                   (Architecture Decision Records - 7 ADRs)
â”œâ”€â”€ .cursor/rules/
â”‚   â”œâ”€â”€ mb-active-context.mdc
â”‚   â”œâ”€â”€ mb-commands.mdc
â”‚   â”œâ”€â”€ mb-product-context.mdc
â”‚   â”œâ”€â”€ mb-system-patterns.mdc
â”‚   â””â”€â”€ mb-tech-stack.mdc
â”œâ”€â”€ docker-compose.yaml    âœ… PostgreSQL 16 + Redis 7
â”œâ”€â”€ package.json           âœ… pnpm workspaces monorepo
â”œâ”€â”€ pnpm-workspace.yaml    âœ… Workspace config
â”œâ”€â”€ tsconfig.json          âœ… Base TypeScript config (strict)
â”œâ”€â”€ .prettierrc            âœ… Code formatting
â””â”€â”€ TODO.md                ðŸ“‹ Implementation roadmap
```

### Project Naming Convention
| Internal Name | Description |
|---------------|-------------|
| `ingestion-api` | Webhook Data Ingestion API (unit ingestion) |
| `stream-api` | Batch Processing API (bulk ingestion via CSV) |
| `live-dashboard` | Real-time Dashboard |

### Source of Truth Hierarchy
1. **Specifications** (`docs/SPEC-*.md`) - Business requirements and acceptance criteria
2. **Architecture Decision Records** (`docs/adr/*.md`) - Documented architectural decisions (7 ADRs)
3. **Memory Bank** (`.cursor/rules/mb-*.mdc`) - Technical patterns and current state
4. **TODO.md** - Detailed implementation roadmap with checklists
5. **Code Implementation** - Must align with specs, ADRs, Memory Bank, and TODO

**Current ADRs:**
- ADR-0001: FastifyAdapter over ExpressAdapter
- ADR-0002: Queue-Based Asynchronous Processing
- ADR-0003: Drizzle ORM over TypeORM/Prisma
- ADR-0004: Zustand over React Context
- ADR-0005: Object Storage for Stream API
- ADR-0006: Postgres COPY Protocol
- ADR-0007: Notification System for Stream API

## 3. Recent Changes
| Date | Type | Description |
| :--- | :--- | :--- |
| 2026-02-03 | Docs | Corrected Memory Bank: Phase 3.1-3.11 complete (was incorrectly showing 3.1-3.3) |
| 2026-01-28 | Feat | Phase 3.11: Created multi-stage Dockerfile for 512MB container deployment |
| 2026-01-28 | Feat | Phase 3.10: Added memory monitoring service (v8 heap statistics) |
| 2026-01-28 | Feat | Phase 3.6-3.9: Transform streams (ValidationTransform, FormatterTransform, postgres-writer) |
| 2026-01-28 | Feat | Phase 3.5: Processing endpoint with streaming pipeline (S3 â†’ CSV â†’ DB) |
| 2026-01-28 | Feat | Phase 3.4: Upload endpoint (HTTP multipart â†’ S3 streaming) |
| 2026-01-28 | Feat | Phase 3.3: Created Object Storage Service (storage, upload, download, cleanup services) |
| 2026-01-28 | Feat | Phase 3.2: Created Fastify server with multipart support and health endpoint |
| 2026-01-28 | Feat | Phase 3.1: Initialized stream-api project with ESM, dependencies, tsconfig |
| 2026-01-28 | Infra | Added MinIO service to docker-compose.yaml (S3-compatible object storage) |
| 2026-01-11 | Docs | Consolidated documentation: Moved spec files to `docs/` folder, created 7 Architecture Decision Records (ADRs) |
| 2026-01-11 | Feat | Added notification system to Stream API spec (status polling + webhook callbacks) |
| 2026-01-11 | Docs | Updated SPEC-STREAM-API.md with object storage architecture and notification system |
| 2026-01-11 | Test | Completed Phase 1.12: Added comprehensive unit test suite (11 test files, 55 tests, 97%+ coverage) |
| 2026-01-11 | Cleanup | Removed unused mock classes (MockRedis, MockDatabase, MockQueue) from test/mocks/ |
| 2026-01-10 | Docs | Added Phase 1.12 (Unit Tests) to roadmap |
| 2026-01-10 | App | Added Dockerfile and docker-compose integration for ingestion-api |
| 2026-01-10 | App | Fixed logger configuration for production Docker environments |
| 2026-01-10 | App | Added WebSocket Gateway (MetricsGateway) for real-time dashboard events |
| 2026-01-10 | App | Added security & rate limiting (@fastify/helmet, cors, rate-limit) |
| 2026-01-10 | App | Added `HealthModule` with Terminus (database, redis, memory_heap checks) |
| 2026-01-09 | Refactor | Renamed `stream-engine` â†’ `stream-api` for consistency |
| 2026-01-09 | Cleanup | Deleted `@distributed-systems-lab/logger` package (unused, NestJS uses nestjs-pino) |
| 2026-01-09 | App | Added demo script for webhook ingestion with idempotency |
| 2026-01-09 | App | Implemented `WorkerModule` with `WebhookProcessor` and `IdempotencyService` |
| 2026-01-09 | App | Added `DatabaseConnection` type export for strict typing |
| 2026-01-09 | App | Implemented `WebhookModule` with controller, service, and DTO validation |
| 2026-01-09 | App | Added `QueueModule` with BullMQ configuration and default job options |
| 2026-01-08 | App | Created `DatabaseModule` with Drizzle ORM connection pooling |
| 2026-01-08 | App | Configured `nestjs-pino` structured logging with pino-pretty in dev mode |
| 2026-01-08 | App | Initialized `apps/ingestion-api` with NestJS 11 + FastifyAdapter (port 3001) |

## 4. Project Status

### Phase 0: Foundation âœ… COMPLETE
- [x] Monorepo initialized (pnpm workspaces)
- [x] Docker Compose (PostgreSQL 16 + Redis 7)
- [x] Root TypeScript config (strict mode)
- [x] Prettier configuration
- [x] `@distributed-systems-lab/dto` package
- [x] `@distributed-systems-lab/database` package (with migrations applied)
- [x] `@distributed-systems-lab/eslint-config` package

### Project 1: Ingestion API (`apps/ingestion-api`)
- **Status**: **âœ… COMPLETE** - All phases (1.1-1.12) complete with comprehensive test coverage
- **Tech Stack**: NestJS 11 + FastifyAdapter + BullMQ + PostgreSQL + Drizzle ORM
- **Key Features**: Webhook ingestion, async processing, idempotency checks, health monitoring, Docker containerization
- **Target KPIs**: 500 VUs, < 100ms P95, < 1% error rate
- **Completed**: 
  - Project setup with FastifyAdapter
  - nestjs-pino structured logging
  - DatabaseModule with Drizzle ORM
  - QueueModule with BullMQ
  - WebhookModule (controller + service + DTO)
  - WorkerModule (processor + idempotency)
  - HealthModule with Terminus (database, redis, memory checks)
  - Security & Rate Limiting (helmet, cors, rate-limit with allowList)
  - WebSocket Gateway (MetricsGateway) for real-time events
  - K6 Load Testing (184,849 requests, 0% error rate, 7.35ms P95, 100% data consistency)
  - Multi-stage Dockerfile and docker-compose integration
  - Comprehensive unit test suite (11 test files, 55 tests, 97%+ statement/line coverage)
- **Load Test Results**: âœ… All KPIs met (0% errors, 7.35ms P95, 499 VUs, 100% data consistency)
- **Test Coverage**: âœ… 97.77% statements, 74.35% branches, 88.46% functions, 97.39% lines

### Project 2: Live Dashboard (`apps/live-dashboard`)
- **Status**: Not started
- **Tech Stack**: Next.js 14 (App Router) + Zustand + Socket.io + Recharts + TailwindCSS
- **Key Features**: Real-time RPS chart, live event stream, socket reconnection
- **Target KPIs**: 60 FPS with 100+ events/sec, < 200ms latency, < 70% CPU
- **Dependencies**: Requires Project 1 WebSocket gateway

### Project 3: Stream API (`apps/stream-api`)
- **Status**: **ðŸš§ IN PROGRESS** - Phases 3.1-3.11 complete
- **Tech Stack**: Node.js 20 Streams + Fastify + pg-copy-streams + S3/MinIO
- **Key Features**: Memory-efficient CSV processing, backpressure handling, bulk inserts
- **Target KPIs**: Process 2GB+ files in 512MB RAM, > 10k rows/sec
- **Dependencies**: Requires shared database module
- **Completed**:
  - Phase 3.1: Project setup (ESM, dependencies, tsconfig)
  - Phase 3.2: Fastify server with multipart support
  - Phase 3.3: Object Storage Service (S3/MinIO integration)
  - Phase 3.4: Upload Endpoint (HTTP â†’ S3 streaming)
  - Phase 3.5: Processing Endpoint (S3 â†’ Database pipeline)
  - Phase 3.6-3.9: Transform Streams (ValidationTransform, FormatterTransform, postgres-writer)
  - Phase 3.10: Memory Monitoring (v8 heap statistics)
  - Phase 3.11: Docker Configuration (multi-stage Dockerfile)

### Shared Packages
| Package | Status | Description |
|---------|--------|-------------|
| `@distributed-systems-lab/dto` | âœ… | WebhookJobData<T>, WebhookEvent<T>, SocketEvents, IngestResponseDto |
| `@distributed-systems-lab/database` | âœ… | Drizzle ORM, webhookEvents schema, connection pool, migrations |
| `@distributed-systems-lab/eslint-config` | âœ… | ESLint 9 flat configs: base, nestjs, nextjs, node |

## 5. Next Steps (Checklist)

### Phase 1: Ingestion API âœ… COMPLETE
- [x] Phase 1.1: Initialize NestJS with FastifyAdapter + nestjs-pino
- [x] Phase 1.2: Configure DatabaseModule with Drizzle ORM
- [x] Phase 1.3: Setup BullMQ queue configuration
- [x] Phase 1.4: Implement WebhookController + DTO validation
- [x] Phase 1.5: Implement WorkerModule with idempotency
- [x] Phase 1.6: Implement WebhookModule (controller + service)
- [x] Phase 1.7: Add HealthModule with Terminus
- [x] Phase 1.8: Security & Rate Limiting
- [x] Phase 1.9: Add WebSocket Gateway for dashboard
- [x] Phase 1.10: K6 load testing (500 VUs acceptance test) âœ…
- [x] Phase 1.11: Dockerfile and docker-compose integration âœ…
- [x] Phase 1.12: Unit Tests (97%+ coverage achieved) âœ…

### Phase 3: Stream API (Current Focus - Switched Order)
- [x] Phase 3.1: Project Setup (ESM, dependencies, tsconfig) âœ…
- [x] Phase 3.2: Fastify Server with multipart support âœ…
- [x] Phase 3.3: Object Storage Service (S3/MinIO) âœ…
- [x] Phase 3.4: Upload Endpoint (HTTP â†’ Object Storage) âœ…
- [x] Phase 3.5: Processing Endpoint (Object Storage â†’ Database) âœ…
- [x] Phase 3.6-3.9: Transform Streams & Pipeline Integration âœ…
- [x] Phase 3.10: Memory Monitoring âœ…
- [x] Phase 3.11: Docker Configuration (512MB limit) âœ…
- [ ] Phase 3.12: OOM Testing (5M rows in 512MB)
- [ ] Phase 3.14: Notification System (status polling + webhook callbacks)

### Phase 2: Live Dashboard (After Stream API)
- [ ] Initialize Next.js 14 with App Router
- [ ] Setup Zustand store for metrics
- [ ] Implement Socket.io client with reconnection
- [ ] Create ThroughputChart with throttled updates
- [ ] Implement LiveLogStream with TanStack Virtual
- [ ] Performance testing (Freeze Test)

## 6. Active Architecture Decisions

### Monorepo Strategy (Decided)
- **Package Manager**: pnpm (v10.23.0) with workspaces
- **Structure**: `apps/*` for applications, `packages/*` for shared code
- **Shared Code**: Types (dto), database (Drizzle), linting (ESLint configs)

### Development Workflow
- **Memory Bank**: Native `.cursor/rules` system with `.mdc` files
- **Command-Based**: Use `/guide`, `/summarize`, `/commit`, etc. for structured AI interactions
- **AI Role**: Assistant/guide - user writes code, AI provides guidance
- **Git Hygiene**: Conventional Commits via `/commit` command
- **Roadmap**: `TODO.md` contains detailed implementation checklist

### Project Interconnections
- **Ingestion API â†’ Dashboard**: WebSocket events for real-time metrics (job-completed)
- **Ingestion API â†” Stream API**: Shared PostgreSQL database via `@distributed-systems-lab/database`
- **All Projects**: Import shared types from `@distributed-systems-lab/dto`

### Infrastructure (Configured)
- **Database**: PostgreSQL 16 Alpine at `localhost:5432` (Docker)
- **Queue**: Redis 7 Alpine at `localhost:6379` (Docker)
- **Object Storage**: MinIO at `localhost:9000` (S3-compatible, console at 9001)
- **Network**: `distributed-lab-network` (Docker bridge)
- **Data Persistence**: `.docker/postgres-data`, `.docker/redis-data`, `.docker/minio-data`

### Port Assignments
| Service | Port |
|---------|------|
| Live Dashboard | 3000 |
| Ingestion API | 3001 |
| Stream API | 3002 |
| PostgreSQL | 5432 |
| Redis | 6379 |
| MinIO API | 9000 |
| MinIO Console | 9001 |

### Testing Strategy
- **Ingestion API**: 
  - K6 load testing (500 VUs, P95 < 100ms) âœ…
  - Unit tests (97%+ coverage, 55 tests) âœ…
- **Dashboard**: Browser performance monitoring (CPU < 70%, 60 FPS)
- **Stream API**: OOM testing (2GB file in 512MB container)

## 7. Critical Constraints

### Performance Requirements
- **Ingestion API**: Must use FastifyAdapter (NOT ExpressAdapter)
- **Dashboard**: Must throttle UI updates to avoid re-render storms
- **Stream API**: Must use `stream.pipeline()` (FORBID `fs.readFileSync`)

### Code Quality Standards
- **TypeScript**: Strict mode enabled, zero `any` types
- **SOLID Principles**: Mandatory across all projects
- **Error Handling**: Result Pattern for business logic, try/catch at boundaries
- **Documentation**: JSDoc on all public functions/classes
- **Logging**: Structured JSON logs (nestjs-pino for NestJS, pino for standalone)
- **Linting**: Use `@distributed-systems-lab/eslint-config/*` presets

## 8. Environment Configuration

### Local Development (.env)
```env
# Database (use localhost for local dev, postgres for Docker-to-Docker)
DB_HOST=localhost
DB_PORT=5432
DB_USER=dev_user
DB_PASSWORD=dev_password
DB_NAME=distributed_lab

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# App Ports
API_PORT=3001
DASHBOARD_PORT=3000
STREAM_API_PORT=3002
```

### Docker Scripts (package.json)
- `pnpm docker:up` - Start PostgreSQL + Redis
- `pnpm docker:down` - Stop containers
- `pnpm docker:logs` - View logs
- `pnpm docker:db` - PostgreSQL CLI
- `pnpm docker:redis` - Redis CLI
- `pnpm docker:clean` - Remove volumes + orphans

## 9. Open Questions / Blockers
- None. **Phase 1 complete** - All acceptance criteria met:
  - âœ… Load testing: 0% errors, 7.35ms P95, 499 VUs
  - âœ… Unit tests: 97%+ coverage, 55 tests passing
  - âœ… Docker containerization complete
  
**Current:** Phase 3 - Stream API (Phases 3.1-3.11 complete)  
**Next:** Phase 3.12 - OOM Testing (5M rows in 512MB container)
